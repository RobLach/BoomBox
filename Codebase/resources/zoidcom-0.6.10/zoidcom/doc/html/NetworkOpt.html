<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Zoidcom: Optimizing Network Data</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
  <script language="JavaScript">
    <!--
    var Img = new Array()
    function doc_image(dateiname)
    {
      this.normal     = new Image()
      this.high       = new Image()
      this.normal.src = dateiname + ".png"
      this.high.src   = dateiname + "h.png"
      return this
    }
    function load_images(name, dateiname)
    {
      Img[name] = new doc_image(dateiname)
    }
    function show_image(name)
    {
      document[name].src = Img[name].high.src
    }
    function hide_image(name)
    {
      document[name].src = Img[name].normal.src
    }
    load_images("Intro", "intro");
    load_images("Overview", "overview");
    load_images("Manual", "manual");
    load_images("Classes", "classref");
    load_images("Headers", "headref");
   -->
   </script>
</head><body>
	      <center>
        <table width="100%" border="0" cellspacing="0" cellpadding="0" height="50">
        <tr height="50">
          <td width="42" height="50" background="headleft.png"></td>
          <td align="center" height="50" background="headback.png"><img src="headcenter.png" alt=""
              height="50" width="582"></td>
          <td width="42" height="50" background="headright.png"></td>
        </tr>
        <tr>
          <td colspan="3" align="center">
            <table width="212" border="0" cellspacing="0" cellpadding="0" align="center">
              <tr>
                <td><img src="linkleft.png" alt="" height="16" width="16" border="0"></td>
                <td><a href="index.html" onMouseOver="show_image('Intro')" onMouseOut="hide_image('Intro')"><img name="Intro" src="intro.png" alt="Introduction" height="16" width="108" border="0"></a></td>
                <td><a href="Manual.html" onMouseOver="show_image('Manual')" onMouseOut="hide_image('Manual')"><img name="Manual" src="manual.png" alt="Manual" height="16" width="108" border="0"></a></td>
                <td><a href="annotated.html" onMouseOver="show_image('Classes')"                         onMouseOut="hide_image('Classes')"><img name="Classes" src="classref.png" alt="Class Reference" height="16" width="108" border="0"></a></td>
                <td><a href="files.html" onMouseOver="show_image('Headers')"                                 onMouseOut="hide_image('Headers')"><img name="Headers" src="headref.png" alt="Header Reference" height="16" width="108" border="0"></a></td>
                <td><img src="linkright.png" alt="" height="16" width="16" border="0"></td>
              </tr>
            </table>
          </td>
        </tr>
      </table>
    </center>
    
    
    
<!-- Generated by Doxygen 1.4.6-NO -->
<h1><a class="anchor" name="NetworkOpt">Optimizing Network Data</a></h1><h2><a class="anchor" name="manualpacking">
Pack the data manually</a></h2>
The classical approach to networking is defining a struct for each message, and the first one or two bytes in the struct denote the packet type, like so:<p>
<div class="fragment"><pre class="fragment"><span class="keyword">struct </span>login_packet_s
{
  <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> packettype;
  <span class="keywordtype">char</span> login[20];
  <span class="keywordtype">char</span> password[20];
  <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> program_version;
};
</pre></div><p>
A system like this can be used with Zoidcom, but is highly inefficient, bandwidth-wise:<p>
<div class="fragment"><pre class="fragment"><a class="code" href="classZCom__BitStream.html">ZCom_BitStream</a> *data = <span class="keyword">new</span> <a class="code" href="classZCom__BitStream.html">ZCom_BitStream</a>();
login_packet_s login;
data-&gt;<a class="code" href="classZCom__BitStream.html#8328e9585283d5f03debbe50b6d077c8">addBuffer</a>(&amp;login, <span class="keyword">sizeof</span>(login));
client-&gt;ZCom_sendData(connection_id_of_server, data);
</pre></div><p>
Whenever the loginname or the password is shorter than 19 characters (+1 byte for the trailing zero), a few bytes get wasted because they are sent anyway. A more efficient way is to pack this data manually into a bitstream:<p>
<div class="fragment"><pre class="fragment"><a class="code" href="classZCom__BitStream.html">ZCom_BitStream</a> *data = <span class="keyword">new</span> <a class="code" href="classZCom__BitStream.html">ZCom_BitStream</a>();
login_packet_s login;
data-&gt;<a class="code" href="classZCom__BitStream.html#960af7c4cab240f9b2768e547b4d7c2b">addInt</a>(PacketType_Login, 8);
data-&gt;<a class="code" href="classZCom__BitStream.html#29e5fc2e9e2506c05fffee5f5e587426">addString</a>(login.login);
data-&gt;<a class="code" href="classZCom__BitStream.html#29e5fc2e9e2506c05fffee5f5e587426">addString</a>(login.password);
data-&gt;<a class="code" href="classZCom__BitStream.html#960af7c4cab240f9b2768e547b4d7c2b">addInt</a>(login.program_version, 16);
client-&gt;ZCom_sendData(connection_id_of_server, data);
</pre></div><p>
<a class="el" href="classZCom__BitStream.html#29e5fc2e9e2506c05fffee5f5e587426">ZCom_BitStream::addString()</a> will only write the actual length of the string to the stream. Granted, you won't be sending login packets 200 times per second, so the savings in this case here are marginal, but the example can be expanded to any message you can think of.<h2><a class="anchor" name="numbercutting">
Pack The Numerics</a></h2>
Numeric values in network messages are often sent as 8, 16 or 32 bit values. Bitstreams allow finer control over the amount of needed bits.<p>
Example: A variable depicting player health. You, as application programmer, know that the maximum value of this variable is 100. So how many bits are needed to cover the whole possible range of it? It's 7, as 2^7 = 128. 6 bits wouldn't suffice as 2^6 = 64 and the health value can go higher than that.<p>
So everytime a health value is packed into a stream, tell the bitstream that only 7 bits are needed. Doing this for one variable won't do much to save traffic, but doing this throughout the whole program for everything you send will save you a lot.<h3><a class="anchor" name="numbercuttingnode">
Example</a></h3>
Each network object that has a node usually has to send different events, so for the header of the events we create an enum with all the possible events.<p>
Something like:<p>
<div class="fragment"><pre class="fragment"><span class="keyword">class </span>MyShip
{
<span class="keyword">public</span>:
  <span class="keyword">enum</span> NetEvents {
    Shoot,
    Die,
    Etc,
    NetEventsCount   <span class="comment">// Counts the amount of events</span>
  };
  <span class="comment">// rest of class</span>
}
</pre></div><p>
Defining this function called bitsOf( n ) that returns the minimum amount of bits needed to encode numerics up to n: <div class="fragment"><pre class="fragment"><span class="keyword">inline</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> bitsOf(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> n)
{
  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> bits = 0;
  <span class="keywordflow">for</span>(; n; n &gt;&gt;= 1)
    bits++;
  <span class="keywordflow">return</span> bits;
}
</pre></div><p>
Each time an event is sent, bitsOf(MyShip::NetEventsCount) is used to determine the optimal amount of bits needed to send any of the enum values.<p>
<div class="fragment"><pre class="fragment"><a class="code" href="classZCom__BitStream.html">ZCom_BitStream</a> *shootevent = <span class="keyword">new</span> <a class="code" href="classZCom__BitStream.html">ZCom_BitStream</a>();
<span class="comment">// add event type</span>
shootevent-&gt;<a class="code" href="classZCom__BitStream.html#960af7c4cab240f9b2768e547b4d7c2b">addInt</a>(MyShip::Shoot, bitsOf(MyShip::NetEventsCount));
<span class="comment">// add more data if needed</span>
node-&gt;sendEvent(<a class="code" href="zoidcom_8h.html#e81e17896b04498c45b6bdea39e530528cde547ee67ad783735ea8b81b4995c5">eZCom_ReliableOrdered</a>, <a class="code" href="zoidcom__node_8h.html#73a79d7facf78f376e014bca02614414">ZCOM_REPRULE_AUTH_2_ALL</a>, shootevent);
</pre></div><p>
This allows you to modify the enum at will and have the program automatically adjust to the minimal amount of bits needed to transmit them.<h2><a class="anchor" name="conditionalpacking">
Conditional Data</a></h2>
Another benefit of sending streams is, that they can be packed more dynamically by embedding condition variables. For example, an enhanced login packet, that can optionally contain extra data about the user logging in:<p>
<div class="fragment"><pre class="fragment"><a class="code" href="classZCom__BitStream.html">ZCom_BitStream</a> *data = <span class="keyword">new</span> <a class="code" href="classZCom__BitStream.html">ZCom_BitStream</a>();
data-&gt;<a class="code" href="classZCom__BitStream.html#960af7c4cab240f9b2768e547b4d7c2b">addInt</a>(PacketType_Login, 8);
data-&gt;<a class="code" href="classZCom__BitStream.html#29e5fc2e9e2506c05fffee5f5e587426">addString</a>(username);
data-&gt;<a class="code" href="classZCom__BitStream.html#29e5fc2e9e2506c05fffee5f5e587426">addString</a>(password);
<span class="keywordflow">if</span> (extra_data_available)
{
  data-&gt;<a class="code" href="classZCom__BitStream.html#9fbcc6828968c222e8d639fc792cdc09">addBool</a>(<span class="keyword">true</span>);
  data-&gt;<a class="code" href="classZCom__BitStream.html#29e5fc2e9e2506c05fffee5f5e587426">addString</a>(comment);
  data-&gt;<a class="code" href="classZCom__BitStream.html#29e5fc2e9e2506c05fffee5f5e587426">addString</a>(phonenumber);
} <span class="keywordflow">else</span>
  data-&gt;<a class="code" href="classZCom__BitStream.html#9fbcc6828968c222e8d639fc792cdc09">addBool</a>(<span class="keyword">false</span>);
data-&gt;<a class="code" href="classZCom__BitStream.html#960af7c4cab240f9b2768e547b4d7c2b">addInt</a>(program_version, 16);
</pre></div><p>
The peer that has to unpack this stream has to execute: <div class="fragment"><pre class="fragment"><span class="keywordtype">int</span> packettype = data-&gt;<a class="code" href="classZCom__BitStream.html#0cc7eb67c7fba69253fe6637957484fd">getInt</a>(8);
<span class="keywordflow">if</span> (packettype == PacketType_Login) {
  <span class="keywordtype">char</span> uname[20]; data-&gt;<a class="code" href="classZCom__BitStream.html#17a39a6579ddd923357cfe4de1cdf635">getString</a>(uname, 20);
  <span class="keywordtype">char</span> passwd[20]; data-&gt;<a class="code" href="classZCom__BitStream.html#17a39a6579ddd923357cfe4de1cdf635">getString</a>(passwd, 20);
  <span class="comment">// if the next bool is true, extra data is coming</span>
  <span class="keywordflow">if</span> (data-&gt;<a class="code" href="classZCom__BitStream.html#b0e1b3c0aa42e220b86bccf6b459d3c6">getBool</a>() == <span class="keyword">true</span>) {
      <span class="keywordtype">char</span> comment[80]; data-&gt;<a class="code" href="classZCom__BitStream.html#17a39a6579ddd923357cfe4de1cdf635">getString</a>(comment, 80);
      <span class="keywordtype">char</span> phonenumber[20]; data-&gt;<a class="code" href="classZCom__BitStream.html#17a39a6579ddd923357cfe4de1cdf635">getString</a>(phonenumber, 20);
  }
  <span class="keywordtype">int</span> client_version = data-&gt;<a class="code" href="classZCom__BitStream.html#0cc7eb67c7fba69253fe6637957484fd">getInt</a>(16);
}
</pre></div><p>
As you can see, for the cost of one bit (the boolean), the extra data is only sent when it is available. This technique can be applied anywhere where Zoidcom is used to send data, so make use of it, as it is another good way to save a lot of bandwidth. </td></tr></table>
<hr size="1"><address style="align: right;"><small>
This file is part of the documentation for Zoidcom. Documentation copyright © 2004-2008 by Jörg Rüppel. Generated on Sat Aug 16 15:26:51 2008 for Zoidcom by&nbsp;<a href="http://www.doxygen.org/index.html"><img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.6-NO</small></address>
</body>
</html>
