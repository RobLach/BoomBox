<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Zoidcom: Communication</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
  <script language="JavaScript">
    <!--
    var Img = new Array()
    function doc_image(dateiname)
    {
      this.normal     = new Image()
      this.high       = new Image()
      this.normal.src = dateiname + ".png"
      this.high.src   = dateiname + "h.png"
      return this
    }
    function load_images(name, dateiname)
    {
      Img[name] = new doc_image(dateiname)
    }
    function show_image(name)
    {
      document[name].src = Img[name].high.src
    }
    function hide_image(name)
    {
      document[name].src = Img[name].normal.src
    }
    load_images("Intro", "intro");
    load_images("Overview", "overview");
    load_images("Manual", "manual");
    load_images("Classes", "classref");
    load_images("Headers", "headref");
   -->
   </script>
</head><body>
	      <center>
        <table width="100%" border="0" cellspacing="0" cellpadding="0" height="50">
        <tr height="50">
          <td width="42" height="50" background="headleft.png"></td>
          <td align="center" height="50" background="headback.png"><img src="headcenter.png" alt=""
              height="50" width="582"></td>
          <td width="42" height="50" background="headright.png"></td>
        </tr>
        <tr>
          <td colspan="3" align="center">
            <table width="212" border="0" cellspacing="0" cellpadding="0" align="center">
              <tr>
                <td><img src="linkleft.png" alt="" height="16" width="16" border="0"></td>
                <td><a href="index.html" onMouseOver="show_image('Intro')" onMouseOut="hide_image('Intro')"><img name="Intro" src="intro.png" alt="Introduction" height="16" width="108" border="0"></a></td>
                <td><a href="Manual.html" onMouseOver="show_image('Manual')" onMouseOut="hide_image('Manual')"><img name="Manual" src="manual.png" alt="Manual" height="16" width="108" border="0"></a></td>
                <td><a href="annotated.html" onMouseOver="show_image('Classes')"                         onMouseOut="hide_image('Classes')"><img name="Classes" src="classref.png" alt="Class Reference" height="16" width="108" border="0"></a></td>
                <td><a href="files.html" onMouseOver="show_image('Headers')"                                 onMouseOut="hide_image('Headers')"><img name="Headers" src="headref.png" alt="Header Reference" height="16" width="108" border="0"></a></td>
                <td><img src="linkright.png" alt="" height="16" width="16" border="0"></td>
              </tr>
            </table>
          </td>
        </tr>
      </table>
    </center>
    
    
    
<!-- Generated by Doxygen 1.4.6-NO -->
<h1><a class="anchor" name="Communication">Communication</a></h1><ul>
<li><a class="el" href="Communication.html#com0">Overview</a></li><li><a class="el" href="Communication.html#com1">Step 1 (Client): Attaching Data To The Connection Request</a></li><li><a class="el" href="Communication.html#com2">Step 2 (Server): Receiving The Attached Data And Sending A Reply</a></li><li><a class="el" href="Communication.html#com3">Step 3 (Client): Receiving The Reply And Sending Data</a></li><li><a class="el" href="Communication.html#com4">Step 4 (Server): Receiving The Data And Sending Strings Back</a></li><li><a class="el" href="Communication.html#com5">Step 5 (Client): Receiving The Strings</a></li><li><a class="el" href="Communication.html#com6">Conclusion</a></li><li><a class="el" href="Communication.html#com7">The Code Complete</a></li></ul>
<h2><a class="anchor" name="com0">
Overview</a></h2>
In this chapter we will extend our client and server from both previous chapters. The goal is to let the client send a password along with the connection request. The server will accept the connection only when the password is correct. After the connection has been established, the client sends a number. The server is expected to send the string "Hello from Server" the requested amount of times back to the client. The client will receive these strings and print them to the console.<h2><a class="anchor" name="com1">
Step 1 (Client): Attaching Data To The Connection Request</a></h2>
Arbitrary data can be attached to a connection request. This way it is possible to perform quick communication between two ZCom_Controls without establishing a full connection. Because no matter if the the server accepts or denies the request, it can always send back a reply. This can be used for several things:<p>
<ul>
<li>Sending login information directly with the connection request</li><li>Identifying the type of client with the connection request (Admin, Observer, Player, ...)</li><li>Pinging the server without connecting to it</li></ul>
<p>
Attaching the data is a simple matter of passing a bitstream object to the connect function.<p>
<div class="fragment"><pre class="fragment"><span class="comment">// assuming the initialized client from the previous chapter here</span>

<span class="comment">// prepare bitstream</span>
<a class="code" href="classZCom__BitStream.html">ZCom_BitStream</a> *password = <span class="keyword">new</span> <a class="code" href="classZCom__BitStream.html">ZCom_BitStream</a>();
password-&gt;<a class="code" href="classZCom__BitStream.html#29e5fc2e9e2506c05fffee5f5e587426">addString</a>(<span class="stringliteral">"let_me_in"</span>);
<span class="comment">// prepare address</span>
<a class="code" href="classZCom__Address.html">ZCom_Address</a> server_addr;
server_addr.<a class="code" href="classZCom__Address.html#896fb817a064267cb29f57335ca89e9c">setAddress</a>( <a class="code" href="zoidcom_8h.html#df333d80d26eb8251868b97511ac3776f7ee7205bd9ce7896ff2b6aa0ad97e8d">eZCom_AddressUDP</a>, 0, <span class="stringliteral">"localhost:10000"</span>);
<span class="comment">// connect</span>
<a class="code" href="zoidcom_8h.html#2fbc85318e50424694925feff4cb61e3">ZCom_ConnID</a> connection_id = client-&gt;ZCom_Connect(server_addr, password);
password = NULL;
</pre></div><p>
<dl compact><dt><b>Attention:</b></dt><dd>As written in <a class="el" href="Basics.html#memory">Memory Management</a>, bitstreams may not be deleted manually when given to a Zoidcom function. That is why the password variable is set to NULL, to explicitly show that the bitstream is of no interest to our code anymore.</dd></dl>
<h2><a class="anchor" name="com2">
Step 2 (Server): Receiving The Attached Data And Sending A Reply</a></h2>
Connection requests will be received by the server through the callback ZCom_cbConnectionRequest. This callback has several parameters which are set by Zoidcom and read by the application code.<p>
The first parameter is _id, which holds the id of the incoming connection. When the connection is accepted by the server, this _id can be used to act on the connection as long as it is alive.<p>
The second parameter is _request. It is a reference to a bitstream, and this bitstream contains whatever the client has attached to the connection request. The goal is to accept the connection only when the correct password has been attached.<p>
The following code is meant to replace the implementation presented in <a class="el" href="Server.html#serv31">Step 3.1 Handling Connection Requests</a> from <a class="el" href="Server.html">The Server</a>.<p>
<div class="fragment"><pre class="fragment"><span class="keyword">class </span>Server : <span class="keyword">public</span> <a class="code" href="classZCom__Control.html">ZCom_Control</a> {
  <span class="keywordtype">bool</span> ZCom_cbConnectionRequest(<a class="code" href="zoidcom_8h.html#2fbc85318e50424694925feff4cb61e3">ZCom_ConnID</a>  _id, <a class="code" href="classZCom__BitStream.html">ZCom_BitStream</a> &amp;_request, <a class="code" href="classZCom__BitStream.html">ZCom_BitStream</a> &amp;_reply ) {
    printf(<span class="stringliteral">"A client requested connection - the new id is [%d].\n"</span>, _id);
    <span class="comment">// get the password</span>
    <span class="keyword">const</span> <span class="keywordtype">char</span> *password = _request.<a class="code" href="classZCom__BitStream.html#808c3d042677a0ca73c412a25b3dc5ba">getStringStatic</a>();
    <span class="comment">// compare it</span>
    <span class="keywordflow">if</span> (password &amp;&amp; strlen(password) &gt; 0 &amp;&amp; strcmp(<span class="stringliteral">"let_me_in"</span>, password) == 0) {
      printf(<span class="stringliteral">"Connection Accepted.\n"</span>);
      _reply.<a class="code" href="classZCom__BitStream.html#29e5fc2e9e2506c05fffee5f5e587426">addString</a>(<span class="stringliteral">"Password Correct."</span>);
      <span class="comment">// accept connection</span>
      <span class="keywordflow">return</span> <span class="keyword">true</span>;
    } <span class="keywordflow">else</span> {
      _reply.<a class="code" href="classZCom__BitStream.html#29e5fc2e9e2506c05fffee5f5e587426">addString</a>(<span class="stringliteral">"Password Wrong."</span>);
      printf(<span class="stringliteral">"Connection Denied.\n"</span>);
      <span class="comment">// deny connection</span>
      <span class="keywordflow">return</span> <span class="keyword">false</span>;
    }
  }
  <span class="comment">// all other callback methods omitted here</span>
};
</pre></div><p>
As you can see, the _reply bitstream in this callback can be filled with data. This data will be received by the client in the ZCom_cbConnectResult() callback.<h2><a class="anchor" name="com3">
Step 3 (Client): Receiving The Reply And Sending Data</a></h2>
When the server wrote data to the _reply bitstream in ZCom_cbConnectionRequest(), this data can be read in the client's ZCom_cbConnectResult() callback. The following code is meant to replace the code from <a class="el" href="Client.html#cli31">3.1 Getting Notified When The Connect Is Done</a> in <a class="el" href="Client.html">The Client</a>.<p>
<div class="fragment"><pre class="fragment"><span class="keyword">class </span>Client : <span class="keyword">public</span> <a class="code" href="classZCom__Control.html">ZCom_Control</a> {
  <span class="keyword">virtual</span> <span class="keywordtype">void</span> ZCom_cbConnectResult( <a class="code" href="zoidcom_8h.html#2fbc85318e50424694925feff4cb61e3">ZCom_ConnID</a> _id, <a class="code" href="zoidcom_8h.html#039b22bf5eba66678d30b92ed5507299">eZCom_ConnectResult</a> _result, 
                                     <a class="code" href="classZCom__BitStream.html">ZCom_BitStream</a> &amp;_reply )
  {
    <span class="keywordflow">if</span> (_result == <a class="code" href="zoidcom_8h.html#039b22bf5eba66678d30b92ed5507299bd98b54942be80fd1ca29628751dae43">eZCom_ConnAccepted</a>)
      printf(<span class="stringliteral">"Connection established. The reply was: %s\n"</span>, _reply.<a class="code" href="classZCom__BitStream.html#808c3d042677a0ca73c412a25b3dc5ba">getStringStatic</a>());
    <span class="keywordflow">else</span> {
      printf(<span class="stringliteral">"Connection failed. The reply was: %s\n"</span>, _reply.<a class="code" href="classZCom__BitStream.html#808c3d042677a0ca73c412a25b3dc5ba">getStringStatic</a>());
      <span class="keywordflow">return</span>;
    }
    
    <span class="comment">// if we get here, the connection was accepted</span>
    
    <span class="comment">// create a bitstream for the request</span>
    <a class="code" href="classZCom__BitStream.html">ZCom_BitStream</a> *therequest = <span class="keyword">new</span> <a class="code" href="classZCom__BitStream.html">ZCom_BitStream</a>();
    <span class="comment">// add the number 9 as a 4 bit value</span>
    therequest-&gt;<a class="code" href="classZCom__BitStream.html#960af7c4cab240f9b2768e547b4d7c2b">addInt</a>(9, 4);
    <span class="comment">// send the data to the server</span>
    ZCom_sendData(_id, therequest);
    <span class="comment">// we are not allowed to delete the stream after it has been sent</span>
    therequest = NULL;
  }

  <span class="comment">// all other callback methods omitted here</span>
</pre></div><p>
This adds two things to the previous implementation. First, the content of the _reply bitstream is read and printed to the console. The bitstream has to contain a string, otherwise getStringStatic() will return NULL. Second, and most importantly, we send the request for the "Hello from Server" string. This is done by creating a new bitstream object, filling it with the number 9 (meaning we want the string 9 times) and then sending the bitstream to the server.<p>
The number is sent as a 4 bit value. That means, the maximum sendable number would be 15. The server will expect a 4 bit value, so it is not possible to simply increase the amount of bits only on the client, as the server will try to read exactly 4 bits. If more bits are needed, the change needs to be done on server and client alike.<p>
ZCom_sendData() sends the data to the connection with the id stored in _id. This happens to be the connection for which we just received the connectresult notification, the connection initially requested with the password "let_me_in". The value stored in _id is also equal to the value stored in connection_id previously declared here: <a class="el" href="Communication.html#com1">Step 1 (Client): Attaching Data To The Connection Request</a>.<h2><a class="anchor" name="com4">
Step 4 (Server): Receiving The Data And Sending Strings Back</a></h2>
When data is sent from the client to the server (or vice versa) through <a class="el" href="classZCom__Control.html#23d36281620c91de8da17627b092aac3">ZCom_Control::ZCom_sendData()</a>, the other side will receive the data through the callback ZCom_cbDataReceived(). The callback provides information about the id of the sending connection and the actual data.<p>
The server implementation for this callback will read an integer as a 4 bit value from the incoming data (because that is what the client should be sending) and then it will send the string "Hello from Server" the read amount of times back to the client.<p>
This code replaces the previously empty callback ZCom_cbDataReceived() in the server class (<a class="el" href="Server.html">The Server</a>).<p>
<div class="fragment"><pre class="fragment"><span class="keyword">class </span>Server : <span class="keyword">public</span> <a class="code" href="classZCom__Control.html">ZCom_Control</a> {
  <span class="keywordtype">void</span> ZCom_cbDataReceived(<a class="code" href="zoidcom_8h.html#2fbc85318e50424694925feff4cb61e3">ZCom_ConnID</a>  _id, <a class="code" href="classZCom__BitStream.html">ZCom_BitStream</a> &amp;_data) {
    <span class="comment">// read 4 bit integer</span>
    <span class="keywordtype">int</span> number = _data.<a class="code" href="classZCom__BitStream.html#0cc7eb67c7fba69253fe6637957484fd">getInt</a>(4);
    printf(<span class="stringliteral">"The client requested our message %d number of times.\n"</span>, number);
    
    <span class="comment">// create a bitstream for the message</span>
    <a class="code" href="classZCom__BitStream.html">ZCom_BitStream</a> *message = <span class="keyword">new</span> <a class="code" href="classZCom__BitStream.html">ZCom_BitStream</a>();
    message-&gt;<a class="code" href="classZCom__BitStream.html#29e5fc2e9e2506c05fffee5f5e587426">addString</a>(<span class="stringliteral">"Hello from Server"</span>);
    
    <span class="comment">// send it as often as requested</span>
    <span class="keywordflow">while</span> (number--)
      ZCom_sendData(_id, message-&gt;<a class="code" href="classZCom__BitStream.html#2ec6199d866bfb208af4efc9d2441bb6">Duplicate</a>());
      
    <span class="comment">// we made a copy for every send, so the original bitstream is unused</span>
    <span class="comment">// and can be deleted</span>
    <span class="keyword">delete</span> message;
  }
  <span class="comment">// all other callback methods omitted here</span>
};
</pre></div><p>
<dl compact><dt><b>Attention:</b></dt><dd>As seen in <a class="el" href="Basics.html#memory">Memory Management</a>, bitstream objects that are sent, don't belong to the application anymore. Zoidcom will work with them and delete them eventually, maybe even immediately. That makes it necessary to create copies of a bitstream via <a class="el" href="classZCom__BitStream.html#2ec6199d866bfb208af4efc9d2441bb6">ZCom_BitStream::Duplicate()</a> whenever the same data shall be sent more than once *and* it is necessary to create the copy *before* sending the data.</dd></dl>
<h2><a class="anchor" name="com5">
Step 5 (Client): Receiving The Strings</a></h2>
The server has sent it's replies with the same function that the client used to send the initial request: ZCom_sendData(). That means that the client will receive the data through the same callback as the server did: ZCom_cbDataReceived().<p>
The server sends the message 9 times (because we sent a 9 in <a class="el" href="Communication.html#com3">Step 3 (Client): Receiving The Reply And Sending Data</a>), and so the callback will get called 9 times, too.<p>
<div class="fragment"><pre class="fragment"><span class="keyword">class </span>Client : <span class="keyword">public</span> <a class="code" href="classZCom__Control.html">ZCom_Control</a> {
  <span class="keywordtype">void</span> ZCom_cbDataReceived(<a class="code" href="zoidcom_8h.html#2fbc85318e50424694925feff4cb61e3">ZCom_ConnID</a>  _id, <a class="code" href="classZCom__BitStream.html">ZCom_BitStream</a> &amp;_data) {
    printf(<span class="stringliteral">"Received a string: %s\n"</span>, _data.<a class="code" href="classZCom__BitStream.html#808c3d042677a0ca73c412a25b3dc5ba">getStringStatic</a>());
  }
  <span class="comment">// all other callback methods omitted here</span>
};
</pre></div><h2><a class="anchor" name="com6">
Conclusion</a></h2>
The communication methods shown here represent only Zoidcom's basic networking functionality. You can stay at this level if you don't want to use object replication at all. When you are using object replication these methods still work, but you will soon find out that it is more convenient to send most data through the objects themselves.<h2><a class="anchor" name="com7">
The Code Complete</a></h2>
<h3><a class="anchor" name="srv2commcode">
The Server</a></h3>
<div class="fragment"><pre class="fragment"><span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<span class="preprocessor">#include &lt;stdio.h&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="zoidcom_8h.html">zoidcom.h</a>&gt;</span>

<span class="keyword">class </span>Server : <span class="keyword">public</span> <a class="code" href="classZCom__Control.html">ZCom_Control</a> 
{
  <span class="comment">// someone tries to connect</span>
  <span class="keywordtype">bool</span> ZCom_cbConnectionRequest(<a class="code" href="zoidcom_8h.html#2fbc85318e50424694925feff4cb61e3">ZCom_ConnID</a>  _id, <a class="code" href="classZCom__BitStream.html">ZCom_BitStream</a> &amp;_request, <a class="code" href="classZCom__BitStream.html">ZCom_BitStream</a> &amp;_reply ) {
    printf(<span class="stringliteral">"A client requested connection - the new id is [%d].\n"</span>, _id);
    <span class="comment">// get the password</span>
    <span class="keyword">const</span> <span class="keywordtype">char</span> *password = _request.<a class="code" href="classZCom__BitStream.html#808c3d042677a0ca73c412a25b3dc5ba">getStringStatic</a>();
    <span class="comment">// compare it</span>
    <span class="keywordflow">if</span> (password &amp;&amp; strlen(password) &gt; 0 &amp;&amp; strcmp(<span class="stringliteral">"let_me_in"</span>, password) == 0) {
      printf(<span class="stringliteral">"Connection Accepted.\n"</span>);
      _reply.<a class="code" href="classZCom__BitStream.html#29e5fc2e9e2506c05fffee5f5e587426">addString</a>(<span class="stringliteral">"Password Correct."</span>);
      <span class="comment">// accept connection</span>
      <span class="keywordflow">return</span> <span class="keyword">true</span>;
    } <span class="keywordflow">else</span> {
      _reply.<a class="code" href="classZCom__BitStream.html#29e5fc2e9e2506c05fffee5f5e587426">addString</a>(<span class="stringliteral">"Password Wrong."</span>);
      printf(<span class="stringliteral">"Connection Denied.\n"</span>);
      <span class="comment">// deny connection</span>
      <span class="keywordflow">return</span> <span class="keyword">false</span>;
    }
  }

  <span class="comment">// someone has connected</span>
  <span class="keywordtype">void</span> ZCom_cbConnectionSpawned( <a class="code" href="zoidcom_8h.html#2fbc85318e50424694925feff4cb61e3">ZCom_ConnID</a> _id ) {
    printf(<span class="stringliteral">"New connection with id [%d]\n"</span>, _id);
  }

  <span class="comment">// someone has disconnected</span>
  <span class="keywordtype">void</span> ZCom_cbConnectionClosed( <a class="code" href="zoidcom_8h.html#2fbc85318e50424694925feff4cb61e3">ZCom_ConnID</a> _id, <a class="code" href="zoidcom_8h.html#ceeefa058937820935af76cec476c6d3">eZCom_CloseReason</a> _reason, <a class="code" href="classZCom__BitStream.html">ZCom_BitStream</a> &amp;_reasondata ) {
    printf(<span class="stringliteral">"Connection with id [%d] closed\n"</span>, _id);
  }
  
  <span class="comment">// someone has sent data</span>
  <span class="keywordtype">void</span> ZCom_cbDataReceived(<a class="code" href="zoidcom_8h.html#2fbc85318e50424694925feff4cb61e3">ZCom_ConnID</a>  _id, <a class="code" href="classZCom__BitStream.html">ZCom_BitStream</a> &amp;_data) {
    <span class="comment">// read 4 bit integer</span>
    <span class="keywordtype">int</span> number = _data.<a class="code" href="classZCom__BitStream.html#0cc7eb67c7fba69253fe6637957484fd">getInt</a>(4);
    printf(<span class="stringliteral">"The client requested our message %d number of times.\n"</span>, number);
    
    <span class="comment">// create a bitstream for the message</span>
    <a class="code" href="classZCom__BitStream.html">ZCom_BitStream</a> *message = <span class="keyword">new</span> <a class="code" href="classZCom__BitStream.html">ZCom_BitStream</a>();
    message-&gt;<a class="code" href="classZCom__BitStream.html#29e5fc2e9e2506c05fffee5f5e587426">addString</a>(<span class="stringliteral">"Hello from Server"</span>);
    
    <span class="comment">// send it as often as requested</span>
    <span class="keywordtype">int</span> i = 1;
    <span class="keywordflow">while</span> (number--) {
      printf(<span class="stringliteral">"Sending #%d\n"</span>, i++);
      ZCom_sendData(_id, message-&gt;<a class="code" href="classZCom__BitStream.html#2ec6199d866bfb208af4efc9d2441bb6">Duplicate</a>());
    }
      
    <span class="comment">// we made a copy for every send, so the original bitstream is unused</span>
    <span class="comment">// and can be deleted</span>
    <span class="keyword">delete</span> message;
  }

  <span class="comment">// currently irrelevant callbacks have empty bodies</span>
  <span class="keywordtype">void</span> ZCom_cbConnectResult( <a class="code" href="zoidcom_8h.html#2fbc85318e50424694925feff4cb61e3">ZCom_ConnID</a> _id, <a class="code" href="zoidcom_8h.html#039b22bf5eba66678d30b92ed5507299">eZCom_ConnectResult</a> _result, <a class="code" href="classZCom__BitStream.html">ZCom_BitStream</a> &amp;_reply ) {}
  <span class="keywordtype">bool</span> ZCom_cbZoidRequest( <a class="code" href="zoidcom_8h.html#2fbc85318e50424694925feff4cb61e3">ZCom_ConnID</a> _id, <a class="code" href="zoidcom__prereq_8h.html#03d096b46d76272f3dad32c0ab64336b">zU8</a> _requested_level, <a class="code" href="classZCom__BitStream.html">ZCom_BitStream</a> &amp;_reason ) {<span class="keywordflow">return</span> <span class="keyword">false</span>;}
  <span class="keywordtype">void</span> ZCom_cbZoidResult( <a class="code" href="zoidcom_8h.html#2fbc85318e50424694925feff4cb61e3">ZCom_ConnID</a> _id, <a class="code" href="zoidcom_8h.html#eddddbe24ae2655f922e0efd2bc479ec">eZCom_ZoidResult</a> _result, <a class="code" href="zoidcom__prereq_8h.html#03d096b46d76272f3dad32c0ab64336b">zU8</a> _new_level, <a class="code" href="classZCom__BitStream.html">ZCom_BitStream</a> &amp;_reason ) {}
  <span class="keywordtype">void</span> ZCom_cbNodeRequest_Dynamic( <a class="code" href="zoidcom_8h.html#2fbc85318e50424694925feff4cb61e3">ZCom_ConnID</a> _id, <a class="code" href="zoidcom_8h.html#bad26ea4fa5a5da6a2f2ccc4c959f87e">ZCom_ClassID</a> _requested_class, <a class="code" href="classZCom__BitStream.html">ZCom_BitStream</a> *_announcedata,
                                   <a class="code" href="zoidcom_8h.html#e5f7ff5ea0cb32c9b0310acab3f63a64">eZCom_NodeRole</a> _role, <a class="code" href="zoidcom_8h.html#c8ad2fe4d62c7d0ba133ecd24307a655">ZCom_NodeID</a> _net_id ) {}
  <span class="keywordtype">void</span> ZCom_cbNodeRequest_Tag( <a class="code" href="zoidcom_8h.html#2fbc85318e50424694925feff4cb61e3">ZCom_ConnID</a> _id, <a class="code" href="zoidcom_8h.html#bad26ea4fa5a5da6a2f2ccc4c959f87e">ZCom_ClassID</a> _requested_class, <a class="code" href="classZCom__BitStream.html">ZCom_BitStream</a> *_announcedata,
                               <a class="code" href="zoidcom_8h.html#e5f7ff5ea0cb32c9b0310acab3f63a64">eZCom_NodeRole</a> _role, <a class="code" href="zoidcom__prereq_8h.html#5469c903acc50ecf1356062dbce2edc6">zU32</a> _tag ) {}
  <span class="keywordtype">bool</span> ZCom_cbDiscoverRequest( <span class="keyword">const</span> <a class="code" href="classZCom__Address.html">ZCom_Address</a> &amp;_addr, <a class="code" href="classZCom__BitStream.html">ZCom_BitStream</a> &amp;_request, 
                               <a class="code" href="classZCom__BitStream.html">ZCom_BitStream</a> &amp;_reply ) {<span class="keywordflow">return</span> <span class="keyword">false</span>;}
  <span class="keywordtype">void</span> ZCom_cbDiscovered( <span class="keyword">const</span> <a class="code" href="classZCom__Address.html">ZCom_Address</a> &amp; _addr, <a class="code" href="classZCom__BitStream.html">ZCom_BitStream</a> &amp;_reply )  {}
};

<span class="keywordtype">int</span> main()
{
  <span class="comment">// initialize Zoidcom</span>
  <a class="code" href="classZoidCom.html">ZoidCom</a>* zcom = <span class="keyword">new</span> <a class="code" href="classZoidCom.html">ZoidCom</a>(<span class="stringliteral">"zoidcom.log"</span>);
  <span class="keywordflow">if</span> (!zcom || !zcom-&gt;<a class="code" href="classZoidCom.html#98e4a1e744c74a98a9f9247ae378ec72">Init</a>())
    exit(255);

  <span class="comment">// make instance of our Server class</span>
  Server *server = <span class="keyword">new</span> Server();
  server-&gt;ZCom_setDebugName(<span class="stringliteral">"Server"</span>);

  <span class="comment">// this creates and initializes the network sockets</span>
  <span class="comment">// true = use udp socket, 10000 = the UDP port to use, 0 = no internal socket</span>
  <span class="keywordtype">bool</span> result = server-&gt;ZCom_initSockets(<span class="keyword">true</span>, 10000, 0);
  <span class="comment">// if result is false, Zoidcom had problems while initializing</span>
  <span class="keywordflow">if</span> (!result)
    exit(255);

  <span class="keywordflow">while</span> ( <span class="keyword">true</span> )
  {
    <span class="comment">// tell the server to process incoming data</span>
    printf(<span class="stringliteral">"Processing input...\n"</span>);
    server-&gt;ZCom_processInput();
    <span class="comment">// tell the server to process outgoing data</span>
    printf(<span class="stringliteral">"Processing output...\n"</span>);
    server-&gt;ZCom_processOutput();
    <span class="comment">// let the program sleep for 0 msecs</span>
    zcom-&gt;<a class="code" href="classZoidCom.html#8f45b79796d3ec0330450db21cd14bda">Sleep</a>(1);
  }

  <span class="keyword">delete</span> server;
  <span class="keyword">delete</span> zcom;

  <span class="keywordflow">return</span> 0;
};
</pre></div> <h3><a class="anchor" name="cli2commcode">
The Client</a></h3>
<div class="fragment"><pre class="fragment"><span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<span class="preprocessor">#include &lt;stdio.h&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="zoidcom_8h.html">zoidcom.h</a>&gt;</span>

<span class="keywordtype">bool</span> exit_now = <span class="keyword">false</span>;

<span class="keyword">class </span>Client : <span class="keyword">public</span> <a class="code" href="classZCom__Control.html">ZCom_Control</a> {
  <span class="keyword">virtual</span> <span class="keywordtype">void</span> ZCom_cbConnectResult( <a class="code" href="zoidcom_8h.html#2fbc85318e50424694925feff4cb61e3">ZCom_ConnID</a> _id, <a class="code" href="zoidcom_8h.html#039b22bf5eba66678d30b92ed5507299">eZCom_ConnectResult</a> _result, 
                                     <a class="code" href="classZCom__BitStream.html">ZCom_BitStream</a> &amp;_reply )
  {
    <span class="keywordflow">if</span> (_result == <a class="code" href="zoidcom_8h.html#039b22bf5eba66678d30b92ed5507299bd98b54942be80fd1ca29628751dae43">eZCom_ConnAccepted</a>)
      printf(<span class="stringliteral">"Connection established. The reply was: %s\n"</span>, _reply.<a class="code" href="classZCom__BitStream.html#808c3d042677a0ca73c412a25b3dc5ba">getStringStatic</a>());
    <span class="keywordflow">else</span> {
      printf(<span class="stringliteral">"Connection failed. The reply was: %s\n"</span>, _reply.<a class="code" href="classZCom__BitStream.html#808c3d042677a0ca73c412a25b3dc5ba">getStringStatic</a>());
      <span class="keywordflow">return</span>;
    }
    
    <span class="comment">// if we get here, the connection was accepted</span>
    
    printf(<span class="stringliteral">"Requesting 9 strings...\n"</span>);
    <span class="comment">// create a bitstream for the request</span>
    <a class="code" href="classZCom__BitStream.html">ZCom_BitStream</a> *therequest = <span class="keyword">new</span> <a class="code" href="classZCom__BitStream.html">ZCom_BitStream</a>();
    <span class="comment">// add the number 9 as a 4 bit value</span>
    therequest-&gt;<a class="code" href="classZCom__BitStream.html#960af7c4cab240f9b2768e547b4d7c2b">addInt</a>(9, 4);
    <span class="comment">// send the data to the server</span>
    ZCom_sendData(_id, therequest);
    <span class="comment">// therequest has been given to Zoidcom and may not be deleted</span>
    therequest = NULL;
  }

  <span class="keywordtype">void</span> ZCom_cbConnectionClosed( <a class="code" href="zoidcom_8h.html#2fbc85318e50424694925feff4cb61e3">ZCom_ConnID</a> _id, <a class="code" href="zoidcom_8h.html#ceeefa058937820935af76cec476c6d3">eZCom_CloseReason</a> _reason, <a class="code" href="classZCom__BitStream.html">ZCom_BitStream</a> &amp;_reasondata )  {
    printf(<span class="stringliteral">"Connection to server closed. Exiting...\n"</span>);
    exit_now = <span class="keyword">true</span>;
  }
  
  <span class="comment">// data was received</span>
  <span class="keywordtype">void</span> ZCom_cbDataReceived(<a class="code" href="zoidcom_8h.html#2fbc85318e50424694925feff4cb61e3">ZCom_ConnID</a>  _id, <a class="code" href="classZCom__BitStream.html">ZCom_BitStream</a> &amp;_data) {
    printf(<span class="stringliteral">"Received a string: %s\n"</span>, _data.<a class="code" href="classZCom__BitStream.html#808c3d042677a0ca73c412a25b3dc5ba">getStringStatic</a>());
  }  

  <span class="keywordtype">bool</span> ZCom_cbConnectionRequest( <a class="code" href="zoidcom_8h.html#2fbc85318e50424694925feff4cb61e3">ZCom_ConnID</a>  _id, <a class="code" href="classZCom__BitStream.html">ZCom_BitStream</a> &amp;_request, <a class="code" href="classZCom__BitStream.html">ZCom_BitStream</a> &amp;_reply ){<span class="keywordflow">return</span> <span class="keyword">false</span>;}
  <span class="keywordtype">void</span> ZCom_cbConnectionSpawned( <a class="code" href="zoidcom_8h.html#2fbc85318e50424694925feff4cb61e3">ZCom_ConnID</a> _id ) {}
  <span class="keywordtype">bool</span> ZCom_cbZoidRequest( <a class="code" href="zoidcom_8h.html#2fbc85318e50424694925feff4cb61e3">ZCom_ConnID</a> _id, <a class="code" href="zoidcom__prereq_8h.html#03d096b46d76272f3dad32c0ab64336b">zU8</a> _requested_level, <a class="code" href="classZCom__BitStream.html">ZCom_BitStream</a> &amp;_reason ) {<span class="keywordflow">return</span> <span class="keyword">false</span>;}
  <span class="keywordtype">void</span> ZCom_cbZoidResult( <a class="code" href="zoidcom_8h.html#2fbc85318e50424694925feff4cb61e3">ZCom_ConnID</a> _id, <a class="code" href="zoidcom_8h.html#eddddbe24ae2655f922e0efd2bc479ec">eZCom_ZoidResult</a> _result, <a class="code" href="zoidcom__prereq_8h.html#03d096b46d76272f3dad32c0ab64336b">zU8</a> _new_level, <a class="code" href="classZCom__BitStream.html">ZCom_BitStream</a> &amp;_reason ) {}
  <span class="keywordtype">void</span> ZCom_cbNodeRequest_Dynamic( <a class="code" href="zoidcom_8h.html#2fbc85318e50424694925feff4cb61e3">ZCom_ConnID</a> _id, <a class="code" href="zoidcom_8h.html#bad26ea4fa5a5da6a2f2ccc4c959f87e">ZCom_ClassID</a> _requested_class, <a class="code" href="classZCom__BitStream.html">ZCom_BitStream</a> *_announcedata,
                                   <a class="code" href="zoidcom_8h.html#e5f7ff5ea0cb32c9b0310acab3f63a64">eZCom_NodeRole</a> _role, <a class="code" href="zoidcom_8h.html#c8ad2fe4d62c7d0ba133ecd24307a655">ZCom_NodeID</a> _net_id ) {}
  <span class="keywordtype">void</span> ZCom_cbNodeRequest_Tag( <a class="code" href="zoidcom_8h.html#2fbc85318e50424694925feff4cb61e3">ZCom_ConnID</a> _id, <a class="code" href="zoidcom_8h.html#bad26ea4fa5a5da6a2f2ccc4c959f87e">ZCom_ClassID</a> _requested_class, <a class="code" href="classZCom__BitStream.html">ZCom_BitStream</a> *_announcedata,
                               <a class="code" href="zoidcom_8h.html#e5f7ff5ea0cb32c9b0310acab3f63a64">eZCom_NodeRole</a> _role, <a class="code" href="zoidcom__prereq_8h.html#5469c903acc50ecf1356062dbce2edc6">zU32</a> _tag ) {}
  <span class="keywordtype">bool</span> ZCom_cbDiscoverRequest( <span class="keyword">const</span> <a class="code" href="classZCom__Address.html">ZCom_Address</a> &amp;_addr, 
                               <a class="code" href="classZCom__BitStream.html">ZCom_BitStream</a> &amp;_request, <a class="code" href="classZCom__BitStream.html">ZCom_BitStream</a> &amp;_reply ) {<span class="keywordflow">return</span> <span class="keyword">false</span>;}
  <span class="keywordtype">void</span> ZCom_cbDiscovered( <span class="keyword">const</span> <a class="code" href="classZCom__Address.html">ZCom_Address</a> &amp; _addr, <a class="code" href="classZCom__BitStream.html">ZCom_BitStream</a> &amp;_reply )  {}
};

<span class="keywordtype">int</span> main()
{
  <span class="comment">// initialize Zoidcom</span>
  <a class="code" href="classZoidCom.html">ZoidCom</a>* zcom = <span class="keyword">new</span> <a class="code" href="classZoidCom.html">ZoidCom</a>(<span class="stringliteral">"zoidcom.log"</span>);
  <span class="keywordflow">if</span> (!zcom || !zcom-&gt;<a class="code" href="classZoidCom.html#98e4a1e744c74a98a9f9247ae378ec72">Init</a>())
    exit(255);

  <span class="comment">// make instance of our Client class</span>
  Client *client = <span class="keyword">new</span> Client();
  client-&gt;ZCom_setDebugName(<span class="stringliteral">"Client"</span>);

  <span class="comment">// this creates and initializes the network sockets</span>
  <span class="comment">// true = use udp socket, 0 = let OS choose UDP port, 0 = no internal socket</span>
  <span class="keywordtype">bool</span> result = client-&gt;ZCom_initSockets(<span class="keyword">true</span>, 0, 0);
  <span class="comment">// if result is false, Zoidcom had problems while initializing</span>
  <span class="keywordflow">if</span> (!result)
    exit(255);

  <span class="comment">// put this into a codeblock so that server_addr gets out of scope before </span>
  <span class="comment">// 'delete zcom;' get called (everything needs to be gone before the </span>
  <span class="comment">// ZoidCom object gets deleted)</span>
  {
    printf(<span class="stringliteral">"Connecting...\n"</span>);
    <span class="comment">// prepare bitstream</span>
    <a class="code" href="classZCom__BitStream.html">ZCom_BitStream</a> *password = <span class="keyword">new</span> <a class="code" href="classZCom__BitStream.html">ZCom_BitStream</a>();
    password-&gt;<a class="code" href="classZCom__BitStream.html#29e5fc2e9e2506c05fffee5f5e587426">addString</a>(<span class="stringliteral">"let_me_in"</span>);
    <span class="comment">// prepare address</span>
    <a class="code" href="classZCom__Address.html">ZCom_Address</a> server_addr;
    server_addr.<a class="code" href="classZCom__Address.html#896fb817a064267cb29f57335ca89e9c">setAddress</a>( <a class="code" href="zoidcom_8h.html#df333d80d26eb8251868b97511ac3776f7ee7205bd9ce7896ff2b6aa0ad97e8d">eZCom_AddressUDP</a>, 0, <span class="stringliteral">"localhost:10000"</span>);
    <span class="comment">// connect</span>
    <a class="code" href="zoidcom_8h.html#2fbc85318e50424694925feff4cb61e3">ZCom_ConnID</a> connection_id = client-&gt;ZCom_Connect(server_addr, password);
    password = NULL;
  }

  <span class="keywordflow">while</span> ( !exit_now )
  {
    <span class="comment">// tell the client to process incoming data</span>
    printf(<span class="stringliteral">"Processing input...\n"</span>);    
    client-&gt;ZCom_processInput();
    <span class="comment">// tell the client to process outgoing data</span>
    printf(<span class="stringliteral">"Processing output...\n"</span>);    
    client-&gt;ZCom_processOutput();
    <span class="comment">// give up remaining cpu time</span>
    zcom-&gt;<a class="code" href="classZoidCom.html#8f45b79796d3ec0330450db21cd14bda">Sleep</a>(1);
  }
  
  <span class="keyword">delete</span> client;
  <span class="keyword">delete</span> zcom;

  <span class="keywordflow">return</span> 0;
};
</pre></div> </td></tr></table>
<hr size="1"><address style="align: right;"><small>
This file is part of the documentation for Zoidcom. Documentation copyright © 2004-2008 by Jörg Rüppel. Generated on Sat Aug 16 15:26:51 2008 for Zoidcom by&nbsp;<a href="http://www.doxygen.org/index.html"><img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.6-NO</small></address>
</body>
</html>
