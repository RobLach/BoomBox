<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Zoidcom: Handling Node Events</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
  <script language="JavaScript">
    <!--
    var Img = new Array()
    function doc_image(dateiname)
    {
      this.normal     = new Image()
      this.high       = new Image()
      this.normal.src = dateiname + ".png"
      this.high.src   = dateiname + "h.png"
      return this
    }
    function load_images(name, dateiname)
    {
      Img[name] = new doc_image(dateiname)
    }
    function show_image(name)
    {
      document[name].src = Img[name].high.src
    }
    function hide_image(name)
    {
      document[name].src = Img[name].normal.src
    }
    load_images("Intro", "intro");
    load_images("Overview", "overview");
    load_images("Manual", "manual");
    load_images("Classes", "classref");
    load_images("Headers", "headref");
   -->
   </script>
</head><body>
	      <center>
        <table width="100%" border="0" cellspacing="0" cellpadding="0" height="50">
        <tr height="50">
          <td width="42" height="50" background="headleft.png"></td>
          <td align="center" height="50" background="headback.png"><img src="headcenter.png" alt=""
              height="50" width="582"></td>
          <td width="42" height="50" background="headright.png"></td>
        </tr>
        <tr>
          <td colspan="3" align="center">
            <table width="212" border="0" cellspacing="0" cellpadding="0" align="center">
              <tr>
                <td><img src="linkleft.png" alt="" height="16" width="16" border="0"></td>
                <td><a href="index.html" onMouseOver="show_image('Intro')" onMouseOut="hide_image('Intro')"><img name="Intro" src="intro.png" alt="Introduction" height="16" width="108" border="0"></a></td>
                <td><a href="Manual.html" onMouseOver="show_image('Manual')" onMouseOut="hide_image('Manual')"><img name="Manual" src="manual.png" alt="Manual" height="16" width="108" border="0"></a></td>
                <td><a href="annotated.html" onMouseOver="show_image('Classes')"                         onMouseOut="hide_image('Classes')"><img name="Classes" src="classref.png" alt="Class Reference" height="16" width="108" border="0"></a></td>
                <td><a href="files.html" onMouseOver="show_image('Headers')"                                 onMouseOut="hide_image('Headers')"><img name="Headers" src="headref.png" alt="Header Reference" height="16" width="108" border="0"></a></td>
                <td><img src="linkright.png" alt="" height="16" width="16" border="0"></td>
              </tr>
            </table>
          </td>
        </tr>
      </table>
    </center>
    
    
    
<!-- Generated by Doxygen 1.4.6-NO -->
<h1><a class="anchor" name="ReplNodeEvents">Handling Node Events</a></h1><ul>
<li>
<a class="el" href="ReplIntro.html">Introduction</a>  </li>
<li>
<a class="el" href="ReplClasses.html">Classes And Class IDs</a>  </li>
<li>
<a class="el" href="ReplNodes.html">Adding The Nodes</a>  </li>
<li>
<a class="el" href="ReplZoidlevel.html">Entering Zoidmode</a>  </li>
<li>
<a class="el" href="ReplAnnounce.html">The Announcement</a>  </li>
<li>
<a class="el" href="ReplNodeEvents.html">Handling Node Events</a>  </li>
<li>
<a class="el" href="ReplNodeDeletion.html">Deleting The Server Nodes</a>  </li>
<li>
<a class="el" href="ReplExtend.html">Extended Object Information</a>  </li>
<li>
<a class="el" href="ReplSummary.html">Replication Summary</a>  </li>
</ul>
<h2><a class="anchor" name="replnodeevents">
Handling Node Events</a></h2>
In order to catch important events related to a node, it is necessary to check for such events on a regular basis. Among these events are notifications about the status of remote counterpart nodes. An authority node on the server will get informed when it has been successfully announced to a client while a proxy node on a client will get informed when it's authority node on the server has been deleted. In addition to that, custom application data can be sent and received through this event system.<h2><a class="anchor" name="replnodeeveimpl">
Example Implementation</a></h2>
Here we add a new method to class GameObject. processNodeEvents() will fetch all currently waiting events from the object's node, and process the only event currently interesting to us: <a class="el" href="zoidcom_8h.html#e31c5d3b58d9e6a36c310277cdea7e0bc023cde4777fbf99ffa4f4a91eafb238">eZCom_EventRemoved</a>. This event will be generated automatically on a client node when it's server node has been deleted, removed or disconnected.<p>
<div class="fragment"><pre class="fragment"><span class="keyword">class </span>GameObject
{
<span class="keyword">protected</span>:
  <a class="code" href="classZCom__Node.html">ZCom_Node</a>*          m_node;
  <span class="comment">// this is new</span>
  <span class="keywordtype">bool</span>                m_deleteme;
<span class="keyword">public</span>:
  GameObject();
  <span class="keyword">virtual</span> ~GameObject();
  
  <span class="comment">// this is new</span>
  <span class="keywordtype">void</span> processNodeEvents();
};

<span class="keywordtype">void</span> GameObject::processNodeEvents()
{
  <span class="comment">// checkEventWaiting() returns true whenever there is a waiting event in the node</span>
  <span class="keywordflow">while</span> (m_node-&gt;checkEventWaiting()) 
  {
    <a class="code" href="zoidcom_8h.html#e31c5d3b58d9e6a36c310277cdea7e0b">eZCom_Event</a>       type;            <span class="comment">// event type</span>
    <a class="code" href="zoidcom_8h.html#e5f7ff5ea0cb32c9b0310acab3f63a64">eZCom_NodeRole</a>    remote_role;     <span class="comment">// role of remote sender</span>
    <a class="code" href="zoidcom_8h.html#2fbc85318e50424694925feff4cb61e3">ZCom_ConnID</a>       conn_id;         <span class="comment">// connection id of sender</span>

    <span class="comment">// get next waiting event</span>
    <a class="code" href="classZCom__BitStream.html">ZCom_BitStream</a> *data = m_node-&gt;getNextEvent(&amp;type, &amp;remote_role, &amp;conn_id);

    <span class="comment">// the server object has been deleted on the server, we should delete it here, too</span>
    <span class="keywordflow">if</span> (remote_role == <a class="code" href="zoidcom_8h.html#e5f7ff5ea0cb32c9b0310acab3f63a640777c9f2721fc458fb027e92e51e7e81">eZCom_RoleAuthority</a> &amp;&amp; type == <a class="code" href="zoidcom_8h.html#e31c5d3b58d9e6a36c310277cdea7e0bc023cde4777fbf99ffa4f4a91eafb238">eZCom_EventRemoved</a>)
      m_deleteme = <span class="keyword">true</span>;
  }
}
</pre></div><p>
checkEventWaiting() returns true whenever there is a waiting event in the node. The waiting event is then fetched with a call to getNextEvent(). This method returns the event data as bitstream pointer, and the event meta information (event id, role of event sender, connection id of event sender) through pointer-parameters. If getNextEvent(NULL, NULL, NULL) is called, the only thing you get is the event data itself. The contents of the data stream depends on the event type though, so it is always necessary to get at least the event type (i.e. the first parameter to getNextEvent() should not be NULL)).<h2><a class="anchor" name="replnodeevedelete">
Handling Deannouncements</a></h2>
The event handled in the above code is received on client nodes when the counterpart server node has been deleted. This actually is the deannouncement mentioned earlier. Of course, you shouldn't delete the object right away with a 'delete this;' statement. Instead, we add a flag 'm_deleteme' to the GameObject which indicates to a possible object handler that the object is garbage. Cleanup can then be done at a proper time.<h2><a class="anchor" name="replnodeevesrvcli">
Same Event Handler Code For Server and Client</a></h2>
Implementing one event handler for each side (client and server) or using the same code to handle events on both sides is up to you. If there are only minimal differences in server and client event handling code, these differences can be included in a one-size-fits-all handler.<p>
<a class="el" href="classZCom__Node.html#af020059d5fa90599465a4da4b20b01e">ZCom_Node::getRole()</a> allows you to find out on which side of the fence the code is executed. When it returns eZCom_RoleAuthority then the node is on the server, while eZCom_RoleProxy and eZCom_RoleOwner implicate that the current node is on the client. So if you want to avoid having two different event handlers for server and client just do something like this:<p>
<div class="fragment"><pre class="fragment"><span class="comment">// pseudocode</span>
<span class="keywordtype">void</span> processNodeEvents()
{
  <span class="keywordflow">while</span> (node-&gt;checkEventWaiting())
  {
    data, type = node-&gt;getNextEvent();
    <span class="keywordflow">if</span> (type == something that appears on both client and server) 
    {
      <span class="comment">// check if we are server</span>
      <span class="keywordflow">if</span> (node-&gt;getRole() == <a class="code" href="zoidcom_8h.html#e5f7ff5ea0cb32c9b0310acab3f63a640777c9f2721fc458fb027e92e51e7e81">eZCom_RoleAuthority</a>) 
      {
        <span class="comment">// do server stuff with the event</span>
      } <span class="keywordflow">else</span>
      {
        <span class="comment">// do client stuff with the event</span>
      }
    }
  }
}
</pre></div><h2><a class="anchor" name="replnodeevealt">
Event Handling Through Callbacks</a></h2>
If you do not like to constantly poll for events, there is also the possibility to handle some or all node events through callbacks similar to the event handling in <a class="el" href="classZCom__Control.html">ZCom_Control</a>. Read about this here: <a class="el" href="OCommIntercept.html">Event Interception</a> </td></tr></table>
<hr size="1"><address style="align: right;"><small>
This file is part of the documentation for Zoidcom. Documentation copyright © 2004-2008 by Jörg Rüppel. Generated on Sat Aug 16 15:26:51 2008 for Zoidcom by&nbsp;<a href="http://www.doxygen.org/index.html"><img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.6-NO</small></address>
</body>
</html>
